<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Manager - Sports Template Generator</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Template manager specific styles */
        .template-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .template-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #007bff;
        }

        .template-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        .template-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 11px;
            max-height: 120px;
            overflow-y: auto;
            margin: 15px 0;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .template-info {
            background: #e3f2fd;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 13px;
        }

        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .edit-form {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #007bff;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }

        .edit-form.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .template-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            height: 250px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="template-manager">
        <div class="header">
            <h1>Template Manager</h1>
            <p class="subtitle">Manage and edit sports result templates</p>
            <div style="margin-top: 20px;">
                <a href="index.html" class="btn btn-secondary">‚Üê Back to Generator</a>
                <button class="btn btn-primary" onclick="showAddTemplateForm()">Add New Template</button>
                <button class="btn btn-warning" onclick="exportTemplates()">Export Templates</button>
            </div>
        </div>
        
        <div class="content-area">
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalTemplates">0</span>
                    <span class="stat-label">Templates</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalMappings">0</span>
                    <span class="stat-label">Mappings</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalSports">0</span>
                    <span class="stat-label">Sports</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="uniqueFields">0</span>
                    <span class="stat-label">Unique Fields</span>
                </div>
            </div>
            
            <div id="templateList" class="template-list">
                <!-- Templates will be loaded here -->
            </div>
            
            <div id="editForm" class="edit-form">
                <h3 id="formTitle">Edit Template</h3>
                <form onsubmit="saveTemplate(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Template ID:</label>
                            <input type="text" id="templateId" required>
                        </div>
                        <div class="form-group">
                            <label>Template Name:</label>
                            <input type="text" id="templateName" placeholder="Descriptive name for this template">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Template Content:</label>
                        <textarea id="templateContent" class="template-editor" required placeholder="Enter your template with variables like {SPORT}, {EVENT}, {ROUND}, etc."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Fields (comma-separated):</label>
                        <input type="text" id="templateFields" placeholder="SPORT, EVENT, ROUND, ATHLETE_NAME, RESULT, etc." required>
                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                            List all the variable fields used in your template (without curly braces)
                        </small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Associated Sport:</label>
                            <input type="text" id="templateSport" placeholder="e.g., ATHLETICS, SWIMMING">
                        </div>
                        <div class="form-group">
                            <label>Associated Event:</label>
                            <input type="text" id="templateEvent" placeholder="e.g., 100M, FREESTYLE">
                        </div>
                        <div class="form-group">
                            <label>Round Type:</label>
                            <input type="text" id="templateRound" placeholder="e.g., finals, semi finals">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Save Template</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="deleteTemplate()" id="deleteBtn" style="display: none;">Delete Template</button>
                        <button type="button" class="btn btn-primary" onclick="previewTemplate()">Preview Template</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let templatesData = null;
        let editingTemplateId = null;

        // Load templates data using the provided JSON structure
        async function loadTemplates() {
            try {
                const response = await fetch('data/sports_templates.json');
                templatesData = await response.json();
                updateStats();
                displayTemplates();
            } catch (error) {
                console.error('Failed to load templates:', error);
                alert('Failed to load templates. Please check if the data file exists.');
            }
        }

        // Update statistics
        function updateStats() {
            if (!templatesData) return;
            
            const totalTemplates = Object.keys(templatesData.templates || {}).length;
            const totalMappings = templatesData.round_mappings ? templatesData.round_mappings.length : 0;
            const uniqueSports = [...new Set(templatesData.round_mappings?.map(m => m.sport) || [])].length;
            
            // Calculate unique fields across all templates
            const allFields = new Set();
            Object.values(templatesData.templates || {}).forEach(template => {
                if (Array.isArray(template.fields)) {
                    template.fields.forEach(field => allFields.add(field));
                }
            });
            
            document.getElementById('totalTemplates').textContent = totalTemplates;
            document.getElementById('totalMappings').textContent = totalMappings;
            document.getElementById('totalSports').textContent = uniqueSports;
            document.getElementById('uniqueFields').textContent = allFields.size;
        }

        // Display templates in cards
        function displayTemplates() {
            const listDiv = document.getElementById('templateList');
            listDiv.innerHTML = '';

            if (!templatesData || !templatesData.templates) {
                listDiv.innerHTML = '<p>No templates found. Please check your data file.</p>';
                return;
            }

            Object.entries(templatesData.templates).forEach(([id, template]) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                
                // Find mappings that use this template
                const mappings = templatesData.round_mappings?.filter(m => m.template_id == id) || [];
                const usageInfo = mappings.length > 0 ? 
                    mappings.slice(0, 3).map(m => `${m.sport} - ${m.event} (${m.round_type})`).join('<br>') +
                    (mappings.length > 3 ? `<br>... and ${mappings.length - 3} more` : '') :
                    '<em>Not currently used</em>';

                const fieldsDisplay = Array.isArray(template.fields) ? 
                    template.fields.join(', ') : 
                    (template.fields || 'No fields defined');

                card.innerHTML = `
                    <h4>Template ${id}</h4>
                    <div class="template-preview">${template.template || 'No template content'}</div>
                    <div class="template-info">
                        <strong>Fields:</strong> ${fieldsDisplay}<br>
                        <strong>Usage:</strong><br>${usageInfo}
                    </div>
                    <div class="template-actions">
                        <button class="btn btn-primary" onclick="editTemplate('${id}')">Edit</button>
                        <button class="btn btn-secondary" onclick="duplicateTemplate('${id}')">Duplicate</button>
                        <button class="btn btn-warning" onclick="testTemplate('${id}')">Test</button>
                        <button class="btn btn-danger" onclick="confirmDelete('${id}')">Delete</button>
                    </div>
                `;
                
                listDiv.appendChild(card);
            });
        }

        // Show add template form
        function showAddTemplateForm() {
            editingTemplateId = null;
            document.getElementById('formTitle').textContent = 'Add New Template';
            document.getElementById('deleteBtn').style.display = 'none';
            
            // Clear form
            clearForm();
            
            document.getElementById('editForm').classList.add('show');
            document.getElementById('editForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Edit existing template
        function editTemplate(templateId) {
            editingTemplateId = templateId;
            const template = templatesData.templates[templateId];
            
            document.getElementById('formTitle').textContent = `Edit Template ${templateId}`;
            document.getElementById('deleteBtn').style.display = 'inline-block';
            
            document.getElementById('templateId').value = templateId;
            document.getElementById('templateContent').value = template.template || '';
            document.getElementById('templateFields').value = Array.isArray(template.fields) ? 
                template.fields.join(', ') : (template.fields || '');
            
            // Find associated mappings
            const mapping = templatesData.round_mappings?.find(m => m.template_id == templateId);
            if (mapping) {
                document.getElementById('templateSport').value = mapping.sport || '';
                document.getElementById('templateEvent').value = mapping.event || '';
                document.getElementById('templateRound').value = mapping.round_type || '';
            }
            
            document.getElementById('editForm').classList.add('show');
            document.getElementById('editForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Save template
        function saveTemplate(event) {
            event.preventDefault();
            
            const templateId = document.getElementById('templateId').value;
            const templateContent = document.getElementById('templateContent').value;
            const templateFields = document.getElementById('templateFields').value
                .split(',').map(f => f.trim()).filter(f => f);
            
            // Update templates data
            if (!templatesData.templates) {
                templatesData.templates = {};
            }
            
            templatesData.templates[templateId] = {
                template: templateContent,
                fields: templateFields
            };
            
            // Save to localStorage (in a real app, you'd send to server)
            localStorage.setItem('updatedTemplates', JSON.stringify(templatesData));
            
            alert('Template saved! Note: Changes are stored locally. Use "Export Templates" to download the updated data.');
            
            updateStats();
            displayTemplates();
            cancelEdit();
        }

        // Cancel editing
        function cancelEdit() {
            document.getElementById('editForm').classList.remove('show');
            editingTemplateId = null;
        }

        // Clear form
        function clearForm() {
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateContent').value = '';
            document.getElementById('templateFields').value = '';
            document.getElementById('templateSport').value = '';
            document.getElementById('templateEvent').value = '';
            document.getElementById('templateRound').value = '';
        }

        // Delete template
        function deleteTemplate() {
            if (editingTemplateId && confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
                delete templatesData.templates[editingTemplateId];
                
                // Remove associated mappings
                if (templatesData.round_mappings) {
                    templatesData.round_mappings = templatesData.round_mappings.filter(
                        m => m.template_id != editingTemplateId
                    );
                }
                
                localStorage.setItem('updatedTemplates', JSON.stringify(templatesData));
                
                alert('Template deleted!');
                updateStats();
                displayTemplates();
                cancelEdit();
            }
        }

        // Confirm delete
        function confirmDelete(templateId) {
            if (confirm(`Are you sure you want to delete Template ${templateId}? This action cannot be undone.`)) {
                editingTemplateId = templateId;
                deleteTemplate();
            }
        }

        // Duplicate template
        function duplicateTemplate(templateId) {
            const template = templatesData.templates[templateId];
            const newId = prompt('Enter new template ID:', `${templateId}_copy`);
            
            if (newId && newId.trim() && !templatesData.templates[newId]) {
                templatesData.templates[newId] = {
                    template: template.template,
                    fields: [...(template.fields || [])]
                };
                
                localStorage.setItem('updatedTemplates', JSON.stringify(templatesData));
                updateStats();
                displayTemplates();
                alert(`Template duplicated as "${newId}"`);
            } else if (templatesData.templates[newId]) {
                alert('A template with that ID already exists!');
            }
        }

        // Test template functionality
        function testTemplate(templateId) {
            const template = templatesData.templates[templateId];
            if (!template) return;
            
            // Create a simple test with sample data
            let testContent = template.template;
            const fields = Array.isArray(template.fields) ? template.fields : [];
            
            fields.forEach(field => {
                const sampleValue = getSampleValue(field);
                testContent = testContent.replace(new RegExp(`\\{${field}\\}`, 'g'), sampleValue);
            });
            
            alert(`Template Test Result:\n\n${testContent}`);
        }

        // Get sample values for testing
        function getSampleValue(field) {
            const fieldUpper = field.toUpperCase();
            
            if (fieldUpper.includes('SPORT')) return 'ATHLETICS';
            if (fieldUpper.includes('EVENT')) return '100M';
            if (fieldUpper.includes('ROUND')) return 'FINALS';
            if (fieldUpper.includes('NAME')) return 'John Doe';
            if (fieldUpper.includes('RESULT')) return '9.58';
            if (fieldUpper.includes('TIME')) return '9.58';
            if (fieldUpper.includes('SCORE')) return '95.50';
            if (fieldUpper.includes('RANK') || fieldUpper.includes('POSITION')) return '1';
            if (fieldUpper.includes('COUNTRY')) return 'USA';
            if (fieldUpper.includes('TEAM')) return 'Team USA';
            if (fieldUpper.includes('DATE')) return '2025-09-05';
            if (fieldUpper.includes('VENUE')) return 'Olympic Stadium';
            
            return `[${field}]`;
        }

        // Preview template functionality
        function previewTemplate() {
            const templateContent = document.getElementById('templateContent').value;
            const fieldsInput = document.getElementById('templateFields').value;
            
            if (!templateContent.trim()) {
                alert('Please enter template content first.');
                return;
            }
            
            const fields = fieldsInput.split(',').map(f => f.trim()).filter(f => f);
            let previewContent = templateContent;
            
            fields.forEach(field => {
                const sampleValue = getSampleValue(field);
                previewContent = previewContent.replace(new RegExp(`\\{${field}\\}`, 'g'), sampleValue);
            });
            
            // Create preview modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Template Preview</h3>
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 20px; font-family: monospace; white-space: pre-wrap; line-height: 1.5;">
                        ${previewContent}
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="this.closest('div').parentElement.remove()" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // Export templates functionality
        function exportTemplates() {
            const dataToExport = localStorage.getItem('updatedTemplates') ? 
                JSON.parse(localStorage.getItem('updatedTemplates')) : templatesData;
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `sports_templates_updated_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Initialize on page load
        window.addEventListener('load', loadTemplates);
    </script>
</body>
</html>
